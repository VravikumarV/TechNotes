

Why Rabbit MQ ?


Features:



When to use ?



http://localhost:15672:			guest / guest

https://www.rabbitmq.com/getstarted.html

rabbitmq-plugins.bat enable rabbitmq_management


RabbitMQ:
************



Exchange:
============

Fanout exchange:   The fanout exchanges, simply ignored its (binding key / routing key) value. It routes the messages to all the quues which are bound to that exchange.

Direct exchange:	The routing algorithm behind a direct exchange is simple - a message goes to the queues whose binding key exactly matches the routing key of the message.

Topic exchange:		Topic exchanges are used to route messages to queues based on wildcard matches between the routing key and the routing pattern which in turn is specified by the queue binding. Based on a matching between a message routing key and this pattern, messages are routed to one or many queues.

Headers Exchange:	Headers exchanges route based on arguments containing headers and optional values. Headers exchanges are very similar to topic exchanges, but it routes based on header values instead of routing keys. A message is considered matching if the value of the header equals the value specified upon binding.





Request-reply
Direct reply-to



Work Queue:		Work Queue that will be used to distribute time-consuming tasks among multiple workers.

Mirror Queue

Dead Letter Queue & Exchange:	RabbitMQ provides an AMQP extension known as the "Dead Letter Exchange" - the dead letter exchange provides functionality to capture messages that are not deliverable.


Routing:





Resources:
*************

https://www.rabbitmq.com/tutorials/tutorial-one-java.html

https://www.rabbitmq.com/management.html

https://www.rabbitmq.com/getstarted.html

https://www.3pillarglobal.com/insights/rabbitmq-understanding-message-broker


FAQ:
************


MessageOrdering
Purging
Dealetter Queue


API
***********

Open Declaration org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter




Configurations:
*******************


disk_free_limit

ActiveMQ vs RabbitMQ vs 
************************





With Spring
**************


org.springframework.amqp.core.MessagePostProcessor


1.  convertAndSend(String routingKey, Object message, MessagePostProcessor messagePostProcessor) throws AmqpException
    Convert a Java object to an Amqp Message and send it to a default exchange with a specific routing key.
    
2.


org.springframework.amqp.core.Message:  The 0-8 and 0-9-1 AMQP specifications do not define an Message class or interface.
Instead, when performing an operation such as basicPublish the content is passed as a byte-array argument and 
additional properties are passed in as separate arguments. Spring AMQP defines a Message class as part of a more general AMQP domain
model representation. The purpose of the Message class is to simply encapsulate the body and properties within a 
single instance so that the rest of the AMQP API can in turn be simpler.



Example:
***********


    Producer:
    ************

package com.techgaint.messaging.config;

import java.util.HashMap;
import java.util.Map;

import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.DirectExchange;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.rabbit.connection.CachingConnectionFactory;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RabbitMQConfig {
	
	@Value("${spring.rabbitmq.template.exchange}")
	private String defaultExchange;
	
	@Value("${spring.rabbitmq.template.routing-key}")
	private String routingKey;

	@Value("${spring.rabbitmq.host}")
	private String host;
	
	@Value("${spring.rabbitmq.username}")
	private String username;

	@Value("${spring.rabbitmq.password}")
	private String password;
	
	@Value("${spring.rabbitmq.queue}")
	private String queueName;
	
	@Bean
	public ConnectionFactory getConnectionFactory() {
		CachingConnectionFactory connectionFactory = new CachingConnectionFactory(host);
		connectionFactory.setUsername(username);
		connectionFactory.setPassword(password);
		return connectionFactory;
	}
	
	@Bean
	DirectExchange exchange() {
		return new DirectExchange(defaultExchange, true, false);
	}

	@Bean
	Queue defaultQueue() {
		Map<String, Object> arguments = new HashMap<String, Object>();
		arguments.put("x-ha-policy", "all");
		Queue defaultQueue = new Queue(queueName, true, false, false, arguments);
		return defaultQueue;
	}
	
	@Bean
	Binding binding(Queue defaultQueue, DirectExchange exchange) {
		return BindingBuilder.bind(defaultQueue).to(exchange).with(routingKey);
	}
	
	@Bean
	public RabbitTemplate getRabbitTemplate(ConnectionFactory rabbitConnectionFactory) {
		RabbitTemplate rabbitTemplate = new RabbitTemplate(rabbitConnectionFactory);
		rabbitTemplate.setRoutingKey(routingKey);
		rabbitTemplate.setQueue(queueName);
		return rabbitTemplate;
	}

}

package com.techgaint.messaging.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.techgaint.messaging.producer.RabbitProducer;

@RestController
@RequestMapping(value = "/api/rabbit")
public class RebbitController {

	@Autowired
	private RabbitProducer  rabbitProducer;
	
	@GetMapping(value = "/{rabbitMsg}")	
	public String postMessage(@PathVariable("rabbitMsg") String rabbitMsg) {
		System.out.println(rabbitMsg);
		rabbitProducer.postMessage(rabbitMsg);
		return "Hello";
	}
	
	@GetMapping(value = "/direct/{exchange}/{routingkey}/{rabbitMsg}")	
	public String postOnDirect(@PathVariable("exchange") String exchange,@PathVariable("routingkey") String routingkey, @PathVariable("rabbitMsg") String rabbitMsg) {
		System.out.println(rabbitMsg);
		rabbitProducer.postOnDirect(exchange,routingkey, rabbitMsg);
		return "Hello";
	}

	@GetMapping(value = "/fanout/{exchange}/{rabbitMsg}")	
	public String postOnFanOut(@PathVariable("exchange") String exchange,@PathVariable("rabbitMsg") String rabbitMsg) {
		System.out.println(rabbitMsg);
		rabbitProducer.postOnFanOut(exchange,rabbitMsg);
		return "Hello";
	}
	
	@GetMapping(value = "/header/{exchange}/{head-1}/{rabbitMsg}")	
	public String postOnHeader(@PathVariable("exchange") String exchange,@PathVariable("head-1") String header,@PathVariable("rabbitMsg") String rabbitMsg) {
		System.out.println(rabbitMsg);
		rabbitProducer.postOnHeader(exchange,header,rabbitMsg);
		return "Hello";
	}
	
	@GetMapping(value = "/topic/{exchange}/{routingKey}/{rabbitMsg}")	
	public String postOnTopic(@PathVariable("exchange") String exchange,@PathVariable("routingKey") String routingKey,@PathVariable("rabbitMsg") String rabbitMsg) {
		System.out.println(rabbitMsg);
		rabbitProducer.postOnTopic(exchange,routingKey,rabbitMsg);
		return "Hello";
	}

}

server.port=8181
spring.rabbitmq.template.retry.max-attempts=4
spring.rabbitmq.host=localhost
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest

spring.rabbitmq.template.exchange=default-exchange
spring.rabbitmq.template.routing-key=default-route
spring.rabbitmq.queue=default-route

Consumer:
*************

package com.techgaint.messaging.config;

import java.util.HashMap;
import java.util.Map;

import org.springframework.amqp.core.AcknowledgeMode;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.DirectExchange;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.rabbit.connection.CachingConnectionFactory;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
import org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.techgaint.messaging.consumer.RabbitMQListener;

@Configuration
public class RabbitMQConfig {

	@Value("${spring.rabbitmq.host}")
	private String host;
	
	@Value("${spring.rabbitmq.username}")
	private String username;

	@Value("${spring.rabbitmq.password}")
	private String password;

	@Value("${spring.rabbitmq.port}")
	private String port;
	
	@Value("${spring.rabbitmq.queue}")
	private String queueName;

	@Value("${spring.rabbitmq.reply-queue}")
	private String replyqueueName;

	@Bean
	public ConnectionFactory getConnectionFactory() {
		CachingConnectionFactory connectionFactory = new CachingConnectionFactory(host);
		connectionFactory.setUsername(username);
		connectionFactory.setPassword(password);
        connectionFactory.setPort(Integer.parseInt(port));
		return connectionFactory;
	}

	
	@Bean
	public RabbitTemplate getRabbitTemplate(ConnectionFactory rabbitConnectionFactory) {
		RabbitTemplate rabbitTemplate = new RabbitTemplate(rabbitConnectionFactory);
		rabbitTemplate.setRoutingKey(replyqueueName);
		return rabbitTemplate;
	}
	
	@Bean
    RabbitMQListener notificationListener() {
        return new RabbitMQListener();
    }

    @Bean
    SimpleMessageListenerContainer container(ConnectionFactory connectionFactory) {
        SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        container.setQueueNames(queueName);
        MessageListenerAdapter messageListenerAdapter = new MessageListenerAdapter(notificationListener());
        container.setMessageListener(messageListenerAdapter);
        container.setChannelTransacted(true);
        /**
         * Explicitly Set the Ack to manual, let container handle Ack part without Listener aware of
         * Channel.
         */
        container.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        return container;
    }

}

package com.techgaint.messaging.consumer;

import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter;
import org.springframework.stereotype.Component;

import com.rabbitmq.client.Channel;

@Component
public class RabbitMQListener extends MessageListenerAdapter {

	@Override
	public void onMessage(Message message, Channel channel) throws Exception {
		// TODO Auto-generated method stub
		String msg = new String(message.getBody());
		System.out.println("message:  "+msg);
		System.out.println("Message Body:  "+message.getBody());
		channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);
	}
	
}

server.port=8182
spring.rabbitmq.host=localhost
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
spring.rabbitmq.queue=q.direct
spring.rabbitmq.reply-queue=q.directs-replay
spring.rabbitmq.port=5672
    
